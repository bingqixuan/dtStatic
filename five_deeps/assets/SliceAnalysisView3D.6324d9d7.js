var Zt=Object.defineProperty,ei=Object.defineProperties;var ti=Object.getOwnPropertyDescriptors;var Ye=Object.getOwnPropertySymbols;var ii=Object.prototype.hasOwnProperty,ai=Object.prototype.propertyIsEnumerable;var Je=(e,t,i)=>t in e?Zt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ze=(e,t)=>{for(var i in t||(t={}))ii.call(t,i)&&Je(e,i,t[i]);if(Ye)for(var i of Ye(t))ai.call(t,i)&&Je(e,i,t[i]);return e},et=(e,t)=>ei(e,ti(t));import{ji as si,fw as ni,mJ as ri,Z as c,d as p,R as li,j_ as tt,lz as it,lA as at,n as ce,aH as oi,fx as le,jr as W,kn as me,f3 as J,di,dj as hi,d2 as ie,dn as st,kt as nt,ds as ci,dB as ui,dD as pi,dE as gi,dF as yi,dG as wi,ku as vi,dy as ue,bR as fi,dM as _i,hB as mi,dR as Pi,hP as Di,dT as bi,dV as Ai,dW as Mi,bP as Vi,dt as Ti,hY as Ei,bs as Ot,kv as C,fS as rt,a0 as d,c$ as G,aJ as kt,lW as Me,lE as It,m3 as O,lh as $t,bj as b,bk as f,lv as o,mZ as $e,aR as H,m_ as Lt,kd as K,f$ as z,kc as I,fy as S,g1 as U,g0 as Ci,mi as N,m$ as Si,n0 as Le,n1 as Oi,n2 as ki,lw as Rt,bh as ne,n3 as Qe,mH as xt,e_ as Z,n4 as Ht,n5 as zt,mh as pe,dA as ge,n6 as Fe,kX as Ii,aU as ee,a2 as y,ks as $i,kg as Re,bX as Gt,n7 as lt,n8 as E,n9 as xe,na as Pe,nb as Li,d1 as Ri,m7 as ot,ms as dt,eA as Te,ew as ht,nc as ct,nd as ut,y as We,u as De,af as pt,ne as xi,l as x,bg as He,da as Nt,nf as Hi,lr as zi,aK as Gi,aL as Ni,ac as Ui,ak as ze,fC as gt,a5 as X,mX as de,ng as T,l_ as fe,li as yt,iS as Ge,ln as Qi,nh as Fi,ex as wt,V as Wi,b6 as vt,lY as ft,lZ as ji,mn as Bi,ni as Ut,ls as Ki,kx as Xi,nj as qi}from"./vendor.d5f590a2.js";import{n as Yi,C as Ji,a as Zi}from"./LineVisualElement.55229a10.js";import{w as he}from"./persistable.1f5489a1.js";import{E as ea}from"./BuildingComponentSublayer.8b813e28.js";import{n as ta,a as ia}from"./projectionUtils.8921d274.js";import{t as je,k as aa,a as sa,p as ye,O as na,c as ra,m as la}from"./analysisViewUtils.9ade0446.js";import{m as oa}from"./ImageMaterial.e832ae83.js";import{C as we}from"./dragEventPipeline3D.87e2abf7.js";let Q=class extends si(ni){constructor(e){super(e),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(e){return this.heading===e.heading&&this.tilt===e.tilt&&ri(this.position,e.position)&&this.width===e.width&&this.height===e.height}};c([p({readOnly:!0,json:{read:!1,write:!0}})],Q.prototype,"type",void 0),c([p({type:li}),he()],Q.prototype,"position",void 0),c([p({type:Number,nonNullable:!0,range:{min:0,max:360}}),he(),tt(e=>it.normalize(at(e),0,!0))],Q.prototype,"heading",void 0),c([p({type:Number,nonNullable:!0,range:{min:0,max:360}}),he(),tt(e=>it.normalize(at(e),0,!0))],Q.prototype,"tilt",void 0),c([p({type:Number,nonNullable:!0}),he()],Q.prototype,"width",void 0),c([p({type:Number,nonNullable:!0}),he()],Q.prototype,"height",void 0),Q=c([ce("esri.analysis.SlicePlane")],Q);const Be=Q,Ee=oi("mac")?"Meta":"Control",Ce="Shift",da=2,ha=1.15,ca=1.15,ua=1.1,pa=2500,ga=.02,ya=Math.cos(me(45)),_t=Math.cos(me(5)),wa=.95,va=.3,fa=.7,oe=W(1,.5,0),Qt=2,Ft=1,ae=le([...oe,fa]),se=[0,0,0,.04],Wt=le([...oe,.5]),_a=le([...oe,1]),ma=J(1,1,1,1),Pa=J(1,.8,.6,1),Da=J(1,.93,.86,1),ba=le([...oe,1]),Aa=le([...oe,1]),Ma=3,mt=11,Va=22.5,_e=40,Pt=48,Ta=2.25,Ea=le([...oe,1]),Ca=4,Dt=1,Sa=.3,Oa=6,ka=4,bt=12,Ia=40,$a=27,At=1600,La=.4;function Ra(e){const t=new di;return t.extensions.add("GL_OES_standard_derivatives"),hi(t,e),t.attributes.add(ie.POSITION,"vec3"),t.attributes.add(ie.UV0,"vec2"),t.varyings.add("vUV","vec2"),t.vertex.code.add(st`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),t.fragment.uniforms.add([new nt("backgroundColor",i=>i.backgroundColor),new nt("gridColor",i=>i.gridColor),new ci("gridWidth",i=>i.gridWidth)]),t.fragment.code.add(st`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}const xa=Object.freeze(Object.defineProperty({__proto__:null,build:Ra},Symbol.toStringTag,{value:"Module"}));class Ha extends mi{constructor(){super(...arguments),this.backgroundColor=J(1,0,0,.5),this.gridColor=J(0,1,0,.5),this.gridWidth=4}}class Ve extends pi{initializeProgram(t){const i=Ve.shader.get().build(this.configuration);return new gi(t.rctx,i,yi)}initializePipeline(){return wi({blending:vi(ue.ONE,ue.ONE,ue.ONE_MINUS_SRC_ALPHA,ue.ONE_MINUS_SRC_ALPHA),depthTest:{func:fi.LESS},colorWrite:_i})}}Ve.shader=new ui(xa,()=>import("./SlicePlaneMaterial.glsl.371dfc9f.js"));class za extends Pi{constructor(t){super(t,new Na),this._config=new Di}intersect(t,i,a,s,n,r,l){return bi(t,i,s,n,r,void 0,l)}createBufferWriter(){return new Ai(Mi)}requiresSlot(t){return t===Vi.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL}createGLMaterial(t){return t.output===Ti.Color?new Ga(t):null}getConfiguration(){return this._config}}class Ga extends Ei{constructor(t){super(t),this.ensureTechnique(Ve,null)}beginSlot(){return Ot(this.technique)}}class Na extends Ha{constructor(){super(...arguments),this.renderOccluded=C.Occlude}}class Ua extends Yi{constructor(t){super(t),this._material=null,this._renderOccluded=C.OccludeAndTransparent,this._gridWidth=1,this._gridColor=J(1,0,0,1),this._backgroundColor=J(1,0,0,1),this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(t){this._gridWidth!==t&&(this._gridWidth=t,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(t){rt(this._gridColor,t),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){rt(this._backgroundColor,t),this._updateMaterial()}createExternalResources(){this._material=new za(this.materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(t){d(this._material)&&t(this._material)}createGeometries(t){if(d(this._material)){const i=G.createSquareGeometry();t.addGeometry(i,this._material)}}get materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){d(this._material)&&this._material.setParameters(this.materialParameters)}}const Qa=kt.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function Fa(e,t,i,a,s,n,r,l){return Wa(t,r.worldUpAtPosition(e,o.get()),s,n,l.basis1,l.basis2),f(l.basis1,l.basis1,i),f(l.basis2,l.basis2,a),H(l.origin,e),Lt(l.basis2,l.basis1,l.origin,l.plane),l}function Wa(e,t,i,a,s,n){const r=z(e,t),l=o.get(),u=o.get();switch(a===k.HORIZONTAL_OR_VERTICAL?Math.abs(r)>ya?k.HORIZONTAL:k.VERTICAL:a){case k.VERTICAL:{const g=Math.abs(r)<=_t?e:i.viewUp;K(l,g,t),H(u,t);break}case k.HORIZONTAL:K(l,i.viewUp,t),K(u,t,l);break;case k.TILTED:{const g=Math.abs(r)<=_t?t:i.viewUp;K(l,g,e),K(u,e,l);break}}const w=K(o.get(),l,u);z(w,i.viewForward)>0&&f(u,u,-1),I(s,l),I(n,u)}function ja(e,t,i){const a=t.worldUpAtPosition(e.origin,o.get()),s=e.basis1,n=qe(e,a),r=Math.round(n/te)*te;return xe(e,r-n,s,i)}function Ba(e,t,i,a,s,n){const r=H(o.get(),s.origin);b(r,r,f(o.get(),s.basis1,e.direction[0]<0?1:-1)),b(r,r,f(o.get(),s.basis2,e.direction[1]<0?1:-1));const l=S(s.basis1),u=S(s.basis2),w=U(o.get(),i,r),g=U(o.get(),t,r);let h=0,D=0;if(Xe(e)){const M=Ne(s),B=Ne(n);h=l-.5*e.direction[0]*z(s.basis1,g)/l,D=u-.5*e.direction[1]*z(s.basis2,g)/u;const q=B/M;h*=q,D*=q}const $=h+.5*e.direction[0]*z(s.basis1,w)/l,m=D+.5*e.direction[1]*z(s.basis2,w)/u,v=f(o.get(),s.basis1,$/l),_=f(o.get(),s.basis2,m/u);($<=0||Vt(n.origin,v,a)<=At)&&H(v,n.basis1),(m<=0||Vt(n.origin,_,a)<=At)&&H(_,n.basis2);const A=H(o.get(),r);return b(A,A,f(o.get(),v,e.direction[0]<0?-1:1)),b(A,A,f(o.get(),_,e.direction[1]<0?-1:1)),$e(A,v,_,n)}function Ka(e,t){return La*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function Xa(e,t,i,a){const s=K(o.get(),t,i);return K(s,s,t),$t(e,s,a)}function jt(e,t){return aa(e.basis1,e.basis2,e.origin,t)}function Mt(e,t,i,a){const s=t.worldUpAtPosition(e.origin,o.get()),n=o.get();switch(i){case re.HEADING:H(n,s);break;case re.TILT:H(n,e.basis1)}return $t(e.origin,n,a)}function qa(e,t,i,a){const s=Ke(i,j.NEGATIVE_X),n=N.get();Si(n,t,s.edge*Math.PI/2);const r=I(o.get(),s.basis);let l=f(o.get(),r,s.direction*a.computeScreenPixelSizeAt(s.position)*_e);b(l,l,s.position);const u=a.projectToRenderScreen(l,Le(o.get())),w=Ya(a,u);Oi(a,u,ve),I(ve.direction,ve.direction);const g=o.get();!w&&ki(i,ve,g)&&(l=g),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=Rt(l),w?e.state|=be:e.state&=~be}function Ya(e,t){const[i,a,s,n]=e.viewport,r=Math.min(s,n)/16;let l=!0;return t[0]<i+r?(t[0]=i+r,l=!1):t[0]>i+s-r&&(t[0]=i+s-r,l=!1),t[1]<a+r?(t[1]=a+r,l=!1):t[1]>a+n-r&&(t[1]=a+n-r,l=!1),l}function Ja(e,t,i,a){const s=S(a.basis1),n=S(a.basis2),r=Bt(a),l=Ne(a),u=ne(o.get(),0,0,0);b(u,f(o.get(),a.basis1,t.direction[0]),f(o.get(),a.basis2,t.direction[1])),b(u,a.origin,u);let w=0,g=1;if(Xe(t))t.direction[0]===1&&t.direction[1]===-1?w=te:t.direction[0]===1&&t.direction[1]===1?w=Math.PI:t.direction[0]===-1&&t.direction[1]===1&&(w=3*Math.PI/2),g=l;else{const D=t.direction[0]!==0?1:2;w=D===1?te:0,g=(D===1?n:s)-r}const h=Qe(N.get(),w);xt(h,h,ne(o.get(),g,g,g)),Z(h,i,h),h[12]=0,h[13]=0,h[14]=0,e.modelTransform=h,e.renderLocation=u}function Za(e,t,i,a){const s=a.worldUpAtPosition(i.origin,o.get()),n=Ke(i,j.POSITIVE_X),r=Qe(N.get(),n.edge*Math.PI/2);Ht(r,r,-qe(i,s)),Z(r,t,r),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=n.position}function es(e,t,i){const a=Ke(i,j.POSITIVE_Y),s=Qe(N.get(),a.edge*Math.PI/2);Ht(s,s,te),Z(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}var j;function Ke(e,t){switch(t){case j.POSITIVE_X:return{basis:e.basis1,direction:1,position:b(o.get(),e.origin,e.basis1),edge:t};case j.POSITIVE_Y:return{basis:e.basis2,direction:1,position:b(o.get(),e.origin,e.basis2),edge:t};case j.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:U(o.get(),e.origin,e.basis1),edge:t};case j.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:U(o.get(),e.origin,e.basis2),edge:t}}}function Vt(e,t,i){const a=i.projectToRenderScreen(b(o.get(),e,t),Le(o.get())),s=i.projectToRenderScreen(U(o.get(),e,t),Le(o.get()));return Ci(U(a,a,s))}function Bt(e){const t=S(e.basis1),i=S(e.basis2);return Sa*Math.min(t,i)}function Ne(e){return Bt(e)}function Xe(e){return e.direction[0]!==0&&e.direction[1]!==0}function ts(e,t=Ae.CENTER_ON_ARROW){const i=t===Ae.CENTER_ON_CALLOUT?_e:0,a=[W(i,0,-Pt/2),W(i,0,Pt/2)],s=ns(a,!0),n=(v,_)=>as(a,a,{tubeRadius:Ma,tipRadius:mt,tipLength:Va,tubeFocusMultiplier:ha,tipFocusMultiplier:ca,padding:v,bothEnds:!0,flat:null,focusTipLength:!0,addCap:_}),r=n(0,!1),l=n(Ta,!0),u=new pe({color:ma,cullFace:ge.Back,renderOccluded:C.Opaque}),w=new pe({color:Pa,cullFace:ge.Back,renderOccluded:C.Opaque}),g=new pe({color:Da,cullFace:ge.Back,renderOccluded:C.Opaque}),h=new pe({color:Aa,transparent:!0,writeDepth:!1,cullFace:ge.Front,renderOccluded:C.Transparent}),D=G.createPolylineGeometry([[i,0,0],[i-_e,0,0]]),$=G.createPolylineGeometry([[i,0,0],[i-_e,0,0]]),m=new Fe({color:ba,renderOccluded:C.OccludeAndTransparent});return new je({view:e,renderObjects:[...r.normal.map(({part:v,geometry:_,transform:A})=>({geometry:_,material:v==="tip"?u:v==="cap"?w:g,transform:A,stateMask:O.Unfocused|P})),...l.normal.map(({geometry:v,transform:_})=>({geometry:v,material:h,transform:_,stateMask:O.Unfocused|P})),{geometry:D,material:m,stateMask:O.Unfocused|P|be},...r.focused.map(({part:v,geometry:_,transform:A})=>({geometry:_,material:v==="tip"?u:v==="cap"?w:g,transform:A,stateMask:O.Focused|P})),...l.focused.map(({geometry:v,transform:_})=>({geometry:v,material:h,transform:_,stateMask:O.Focused|P})),{geometry:$,material:m,stateMask:O.Focused|P|be}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:mt,state:P})}function Tt(e,t){const i=new oa({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:C.Opaque}),a=Ia,s=$a,n=s*ua,r=h=>{const D=new Uint32Array([0,1,2,2,3,0]);return new Ri([[ie.POSITION,{size:3,data:[a-h,-h,0,a+h,-h,0,a+h,h,0,a-h,h,0],exclusive:!0}],[ie.UV0,{size:2,data:[0,0,1,0,1,1,0,1]}]],[[ie.POSITION,D],[ie.UV0,D]])},l=G.createPolylineGeometry([[0,0,0],[a-s,0,0]]),u=G.createPolylineGeometry([[0,0,0],[a-n,0,0]]),w=new Fe({color:_a,renderOccluded:C.OccludeAndTransparent}),g=[{geometry:r(s),material:i,stateMask:O.Unfocused|P},{geometry:l,material:w,stateMask:O.Unfocused|P},{geometry:r(n),material:i,stateMask:O.Focused|P},{geometry:u,material:w,stateMask:O.Focused|P}];return new je({view:e,renderObjects:g,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},collisionPriority:1,radius:s/2,state:P})}function Kt(e){const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new Ji({view:e,attached:!0,color:ae,width:Ft,writeDepthEnabled:!1,renderOccluded:C.OccludeAndTransparent,geometry:[t]})}function Xt(e){return new Ua({view:e,attached:!0,backgroundColor:[...se],gridColor:Wt,gridWidth:4,renderOccluded:C.OccludeAndTransparent})}function is(e,t){const i=Xe(t),a=i?[W(1,0,0),W(0,0,0),W(0,1,0)]:[W(1,0,0),W(-1,0,0)],s=G.createPolylineGeometry(a),n=Ea,r=m=>new Ii({color:n,width:m,renderOccluded:C.OccludeAndTransparent}),l=()=>new Fe({color:n,renderOccluded:C.OccludeAndTransparent}),u=i?Ca:Dt,w=u*da,g=Dt,h=m=>m>1?r(m):l(),D=[{geometry:s,material:h(u),stateMask:O.Unfocused|Se},{geometry:s,material:h(w),stateMask:O.Focused|Se},{geometry:s,material:h(g),stateMask:hs}],$=new je({view:e,renderObjects:D,collisionType:{type:"line",paths:[a]},autoScaleRenderObjects:!1,worldSized:!0,radius:i?Oa:ka});return $.state=Se,$}function as(e,t,i){const a=s=>{const n=(s?t:e).slice(0),r=U(o.get(),n[0],n[1]);I(r,r);const l=U(o.get(),n[n.length-1],n[n.length-2]);if(I(l,l),i.padding>0){const M=f(ee(),l,-i.padding);if(n[n.length-1]=b(M,M,n[n.length-1]),i.bothEnds){const B=f(ee(),r,-i.padding);n[0]=b(B,B,n[0])}}const u=s?i.tipFocusMultiplier:1,w=i.tipLength*(i.focusTipLength?u:1),g=i.tipRadius*u,h=ot(N.get());if(i.padding>0){const M=w/4,B=ne(o.get(),0,M,0),q=1+i.padding/M;dt(h,h,B),xt(h,h,ne(o.get(),q,q,q)),dt(h,h,f(B,B,-1/q))}const D=ot(Te()),$=W(0,1,0),m=ht(Te(),ct(ut.get(),$,l));m[12]=n[n.length-1][0],m[13]=n[n.length-1][1],m[14]=n[n.length-1][2],Z(m,m,h);const v=[{part:"tube",geometry:ss(i.tubeRadius*(s?i.tubeFocusMultiplier:1)+i.padding,i.flat,n),transform:D}];let _,A;if(d(i.flat)?_=G.createExtrudedTriangle(w,g,g,i.flat.thickness):(_=G.createConeGeometry(w,g,24,!1,!1,!0),A=G.createConeGeometry(w,g,24,!1,!0,!1)),v.push({part:"tip",geometry:_,transform:m}),A&&v.push({part:"cap",geometry:A,transform:m}),i.bothEnds){const M=ht(Te(),ct(ut.get(),$,r));M[12]=n[0][0],M[13]=n[0][1],M[14]=n[0][2],Z(M,M,h),v.push({part:"tip",geometry:_,transform:M}),A&&v.push({part:"cap",geometry:A,transform:M})}return v};return{normal:a(!1),focused:a(!0)}}function ss(e,t,i){const a=[];if(d(t))a.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else for(let n=0;n<12;n++){const r=n/12*2*Math.PI;a.push([Math.cos(r)*e,Math.sin(r)*e])}return G.createPathExtrusionGeometry(a,i,[],[],!1)}function ns(e,t){const i=U(ee(),e[e.length-1],e[e.length-2]);if(I(i,i),f(i,i,bt),b(i,i,e[e.length-1]),t){const a=U(ee(),e[0],e[1]);return I(a,a),f(a,a,bt),b(a,a,e[0]),[a,...e,i]}return[...e,i]}function qt(e,t,i,a=new Be){if(y(e))return null;const{renderCoordsHelper:s}=t,n=s.fromRenderCoords(e.origin,t.spatialReference);if(y(n))return null;const r=$i(n,i);if(y(r))return null;a.position=r;const l=s.worldUpAtPosition(e.origin,o.get()),u=s.worldBasisAtPosition(e.origin,Re.Y,o.get()),w=2*S(e.basis1),g=2*S(e.basis2),h=Gt.renderUnitScaleFactor(t.spatialReference,i);return a.width=w*h,a.height=g*h,a.tilt=lt(qe(e,l)),a.heading=lt(rs(e,l,u)),a}function qe(e,t){return zt(t,e.basis2,e.basis1)+te}function rs(e,t,i){return zt(e.basis1,i,t)-te}function ls(e,t,i,a,s,n,r=E()){return n.toRenderCoords(e,r.origin)?(n.worldBasisAtPosition(r.origin,Re.X,r.basis1),n.worldBasisAtPosition(r.origin,Re.Y,r.basis2),Lt(r.basis2,r.basis1,r.origin,r.plane),xe(r,-me(t),Pe(r),r),xe(r,me(i),r.basis1,r),f(r.basis1,r.basis1,a/2),f(r.basis2,r.basis2,s/2),Li(r),r):(Qa.error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}function os(e,t){if(y(e)||y(e.position))return null;const i=ta(e.position,t.spatialReference,t.elevationProvider);if(y(i))return null;const a=Gt.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),s=e.width*a,n=e.height*a;return{position:i,heading:e.heading,tilt:e.tilt,renderWidth:s,renderHeight:n}}function ds(e,t,i,a=E()){if(y(e))return null;const s=ls(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,a);return!i.tiltEnabled&&d(s)&&ja(s,t.renderCoordsHelper,s),s}(function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"})(j||(j={}));const P=Me.Custom1;var re,k;(function(e){e[e.HEADING=1]="HEADING",e[e.TILT=2]="TILT"})(re||(re={})),function(e){e[e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.TILTED=3]="TILTED"}(k||(k={}));const be=Me.Custom2,ve=It(),te=Math.PI/2,Se=Me.Custom1,hs=Me.Custom2;var Ae;function cs(e){const t=e.type==="building-scene-3d"?e:null;return d(t)}(function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(Ae||(Ae={}));const Oe=kt.getLogger("esri.views.3d.analysis.Slice.SliceController");let F=class extends We{constructor(e){super(e),this._handles=new De,this._internalChange=!1,this._currentSlicePlane=null,this.state="ready"}get ready(){return this.state==="ready"}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",e=>{const t=e.item;t!=null&&(t instanceof pt||t instanceof ea)?t instanceof pt&&xi(t)?(Oe.error("excludedLayers",`Layer '${t.title}, id:${t.id}' of type '${t.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(t)&&e.preventDefault():(Oe.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())})),ps(this.view,this),this._handles.add([x(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),x(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),x(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),x(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this._handles.add([x(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._set("state","ready"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.state!=="destroyed"&&(this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),gs(this.view,this),this._handles.destroy(),this.set("view",null),this._set("state","destroyed"))}async whenReady(){return await He(()=>this.ready),this}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(cs).flatMap(({sublayerViews:t})=>t.items))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,t=this._currentSlicePlane;if(y(t)&&y(e)||d(t)&&d(e)&&e.equals(t))return;let i=null,a=null;if(d(e)&&d(e.position)){const s=e.position.spatialReference,n=os(e,this.view);y(n)&&ia(this.analysis,s,Oe),i=ds(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},E()),d(i)&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,t=qt(e,this.view,this.view.spatialReference,new Be);let i=null;d(t)&&(i={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height}),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=t,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(ke)return;const e=Yt(this.view);if(this.analysisViewData.active)d(e.activeController)&&e.activeController!==this?(ke=!0,e.activeController.analysisViewData.active=!1,ke=!1):d(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(d(e.activeController)&&e.activeController!==this)return;d(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){this.state==="ready"&&us(this.view)}_updateLayerViews(){const e=d(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,t=[],i=a=>{"layers"in a?a.layers.forEach(i):t.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&!t.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=e&&!t.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};c([p({readOnly:!0})],F.prototype,"state",void 0),c([p()],F.prototype,"view",void 0),c([p()],F.prototype,"analysis",void 0),c([p()],F.prototype,"analysisViewData",void 0),c([p()],F.prototype,"ready",null),c([p()],F.prototype,"_allLayerAndSubLayerViews",null),F=c([ce("esri.views.3d.analysis.Slice.SliceController")],F);const Y=new Map;let ke=!1;function us(e){const t=Yt(e).activeController;d(t)&&d(t.analysisViewData.plane)&&t.analysisViewData.visible?e.slicePlane=t.analysisViewData.plane:e.slicePlane=null}function ps(e,t){Y.has(e)||Y.set(e,{all:[],activeController:null}),Y.get(e).all.push(t)}function Yt(e){return Y.get(e)}function gs(e,t){if(!Y.has(e))throw new Error("view expected in global slice register");const i=Y.get(e),a=i.all.lastIndexOf(t);if(a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&Y.delete(e)}const Et="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAnFBMVEUAAAD/gAD/gAD/cAD/gAD/eAD/gAD/eQD/gAD/egD/gAD/ewD/gAD/fAD/gAD/fAD/gAD/fAD/fQD/fQD/fQD/fQD/fQD/fgD/jR7/mjn/mjf/p1H/plH/smf/sWb/vHr/u3n/xYz/xIv/zZz/zJv/zJr/1Kv/1Kr/06r/06n/27n/27f/4cX/4cT/59D/7dr/8uX/9u7/+/f////u2EN0AAAAM3RSTlMACBAQICAoKDAwODhAQEhIUFBYYGhweICIkJCXmJ+gp6ivsLe4uL+/wMDHx8/P19/n7/cWvjXwAAACeUlEQVR42tWX3XqiMBCGY2pbtbrUnzhhdak/lHWliJD7v7fdJ+KG5AMhh30P8zCTmS+TycDaeBoHi5Wgf4jVYvbKmRfPgSAHMX9mPRnM1tSIGHM/c2QddLp4c8wxCvYIvqROBPfbHlm/sRYC6smMNTKn3sxZAyvyYNW1v38MM/IkcPQnZHPMLtciz9P9hhqwzoLD+cnfpTIUaYinyZlBkE2YKZcMXCyN/YhsPkuFlMfWJLiwo89VMxfpJDForMCwuG+Zx7ttGO2S/w4LJ42ZURDty5M0a4dqsZAQAihQfXqWdlhnpcmdEPAI0tv2EbnsbsKmdgi6/1GN7T1XJLx5sF0P9SWABMC+co5JBE4Ge/1NTM3EGIJgjFONXCdAbeQYwhN7pRrRV20LJNIhWOczdu+xPFzIBiQ62iIsyIOTvlZUY+HXySLQaMUEeSC1CPYxENIlwk+q8e0clFAIfiKG+qpaIvod4wfU8sqvkDLda+xCCqgDaAk7uyeNqD+feFlfGCcg3Hzsk+xS7Nz1Aq4CcauhhMc0uxaqIgcFsF0J+1WQyoCN7Y9ezeCVH5LhSxmyRvsihKbK1m7LafpSpkpj6yJgtsiVBh6AX5UyCVmMbrNpcwj5/h6DPN79JjAiQAhXVeN6SZI0q5bQnn4wBiHEqpUybp1ZJzWxStVCHhKhAhVLp/Emh6trHpGLaB6yZHk7wu3Z+ChOxhwUNEmYYjpUvqJDksSHraQmJm2DdqQK6sGUObybYtpSN+8Phm3pN2xjDH33R6b0CKxAZNLvl8foD3BBnSw5e8RI+G2P8GD9wHw6YN3wkfA0R4Zz8CGCIfOCv8zM738walXuLw6nXBvPr8wvAAAAAElFTkSuQmCC",Ct="data:image/png;base64,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",Jt={mipmap:!0,preMultiplyAlpha:!0,width:64,height:64};function ys(e){return e.fromData(Et,()=>new Nt(Et,Jt))}function ws(e){return e.fromData(Ct,()=>new Nt(Ct,Jt))}var Ue;let V=Ue=class extends sa{constructor(e){super(e),this.clock=Hi,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this.layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._handles=new De,this._viewHandles=new De,this._frameTask=null,this._pointerMoveTimerMs=pa,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=E(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=zi(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=Gi(e.view.state.viewingMode),this._intersector.options.store=Ni.MIN}initialize(){if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.rotateHeadingImage=ys(this.view.toolViewManager.textures),this.rotateTiltImage=ws(this.view.toolViewManager.textures);const e=i=>{this._updateManipulatorsInteractive(i),i.grabbing||(d(this.analysisViewData.plane)&&T(this.analysisViewData.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=ts(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",i=>{this._onShiftGrab(i),e(this.shiftManipulator)}),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=Tt(this.view,this.rotateHeadingImage.texture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",i=>{this._onRotateHeadingGrab(i),e(this.rotateHeadingManipulator)}),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=Tt(this.view,this.rotateTiltImage.texture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",i=>{this._onRotateTiltGrab(i),e(this.rotateTiltManipulator)}),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map((i,a)=>{const s=is(this.view,i);return s.events.on("grab-changed",n=>{this._onResizeGrab(n,a),e(s)}),this._handles.add(this._createResizeDragPipeline(s)),s}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=Xt(this.view),this._previewPlaneOutlineVisualElement=Kt(this.view),this._previewPlaneOutlineVisualElement.width=Qt,this._handles.add(x(()=>this.analysisViewData.plane,()=>this._updateManipulators(),Ui));const t=x(()=>this.state,i=>{i==="sliced"&&this.finishToolCreation()},ze);this._handles.add([t,x(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this.rotateHeadingImage=gt(this.rotateHeadingImage),this.rotateTiltImage=gt(this.rotateTiltImage),this._handles=X(this._handles),this._viewHandles=X(this._viewHandles),this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=X(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=X(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":d(this._creatingPointerId)?"grabbing":null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this._handles.remove("analysis"),this._set("analysis",e)}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=d(e)&&e.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return d(this.inputState)&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){y(this.analysisViewData.plane)||(this._set("layersMode","exclude"),this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){y(this.analysisViewData.plane)||(this._set("layersMode","none"),this.active&&(this.view.activeTool=null))}onDeactivate(){this._set("layersMode","none"),this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this.shiftManipulator&&(this._updateManipulators(),e||this._clearPointerMoveTimeout())}onInputEvent(e){switch(e.type){case"pointer-drag":if(!Ie(e))return;this._isPlacingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!Ie(e))return;this._onClickPlacePlane(e)&&e.stopPropagation();break;case"click":if(!Ie(e))return;this._onClickExcludeLayer(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.editable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&d(t)&&t.type==="shift"){const i=de(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:i,screenPoint:i}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(de(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&d(this.analysisViewData.plane)){const t=de(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),T(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const t=de(e),i=E();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){if(T(i,this._startPlane),this.analysis.shape=qt(i,this.view,this.view.spatialReference,new Be),e.type==="pointer-drag"){const a=this._calculatePickRay(t);this.inputState=St(a,e.pointerId,i.origin,i)}return!0}}return!1}_onClickExcludeLayer(e){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(de(e)).then(t=>{if(t.results.length){const i=t.results[0],a=(i==null?void 0:i.type)==="graphic"&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0}),this._set("layersMode","none"),this.active&&(this.view.activeTool=null),!0)}_onKeyDown(e){return(e.key===Ce||e.key===Ee)&&(this._activeKeyModifiers[e.key]=!0,d(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==Ce&&e.key!==Ee||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],d(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||y(this.analysisViewData.plane))return;const t=this._calculatePickRay(e.screenPoint);T(this.analysisViewData.plane,this._startPlane),this.inputState=St(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return ye(e,(t,i,a)=>{const s=this.inputState;if(y(s)||s.type!=="shift")return;const n=d(this.analysisViewData.plane)?T(this.analysisViewData.plane,E()):null;i.next(we(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{d(n)&&this._updateBoundedPlane(n)})})}_shiftDragAdjustSensitivity(e){return t=>{if(y(this.analysisViewData.plane))return null;const i=.001,a=Math.min((1-Math.abs(z(Pe(this.analysisViewData.plane),t.ray.direction)/S(t.ray.direction)))/i,1),s=-yt(this._startPlane.plane,t.renderEnd),n=-yt(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-n,t}}_shiftDragUpdatePlane(e){return()=>{if(y(this.analysisViewData.plane))return;const t=H(o.get(),this._startPlane.origin),i=H(o.get(),Pe(this._startPlane));f(i,i,-e.depth),b(i,i,t);const a=$e(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,E());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(e){if(e.action!=="start"||y(this.analysisViewData.plane))return;const t=Mt(this.analysisViewData.plane,this.view.renderCoordsHelper,re.HEADING,Ge()),i=this._calculatePickRay(e.screenPoint),a=ee();fe(t,i,a)&&(T(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateHeadingDragPipeline(e){return ye(e,(t,i,a)=>{const s=this.inputState;if(y(s)||s.type!=="rotate")return;const n=d(this.analysisViewData.plane)?T(this.analysisViewData.plane,E()):null;i.next(we(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{d(n)&&this._updateBoundedPlane(n)})})}_onRotateTiltGrab(e){if(e.action!=="start"||y(this.analysisViewData.plane))return;const t=Mt(this.analysisViewData.plane,this.view.renderCoordsHelper,re.TILT,Ge()),i=this._calculatePickRay(e.screenPoint),a=ee();fe(t,i,a)&&(T(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateTiltDragPipeline(e){return ye(e,(t,i,a)=>{const s=this.inputState;if(y(s)||s.type!=="rotate")return;const n=d(this.analysisViewData.plane)?T(this.analysisViewData.plane,E()):null;i.next(we(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{d(n)&&this._updateBoundedPlane(n)})})}_rotateDragRenderPlaneToRotate(e){return t=>{if(y(this.analysisViewData.plane))return null;const i=Qi(e.rotatePlane),a=na(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,i);return et(Ze({},t),{rotateAxis:i,rotateAngle:a})}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(y(this.analysisViewData.plane))return;const t=Fi(N.get(),e.rotateAngle,e.rotateAxis);if(y(t))return;const i=wt(o.get(),this._startPlane.basis1,t),a=wt(o.get(),this._startPlane.basis2,t),s=$e(this.analysisViewData.plane.origin,i,a,E());this._updateBoundedPlane(s)}}_onResizeGrab(e,t){if(e.action!=="start"||y(this.analysisViewData.plane))return;const i=this._calculatePickRay(e.screenPoint),a=o.get();fe(this.analysisViewData.plane.plane,i,a)&&(T(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:Rt(a)})}_createResizeDragPipeline(e){return ye(e,(t,i,a)=>{const s=this.inputState;if(y(s)||s.type!=="resize"||y(this.analysisViewData.plane))return;const n=T(this.analysisViewData.plane,E());i.next(we(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(n)})})}_resizeDragUpdatePlane(e){return t=>{if(y(this.analysisViewData.plane))return;const i=this._resizeHandles[e.activeHandleIdx],a=Ba(i,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,T(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(!d(t))throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){let i=this._previewPlane;if(this._previewPlane=null,y(e))return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=d(i)?i:E();if(i=d(i)?T(i,vs):null,this._pickPlane(e,!0,t,a)){const s=wa;let n=!1;d(i)&&(n=z(i.plane,a.plane)<s||z(I(o.get(),i.basis1),I(o.get(),a.basis1))<s),n&&(this._previewPlaneOpacity=0),this._previewPlane=a}}d(this._previewPlane)&&y(this._frameTask)&&this._previewPlaneOpacity===0?this._frameTask=Wi({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*va),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):y(this._previewPlane)&&d(this._frameTask)?this._removeFrameTask():d(this._previewPlane)&&this._updateManipulators()}_removeFrameTask(){this._frameTask=vt(this._frameTask)}_calculatePickRay(e){const t=It(),i=ft(e,fs);return ji(this.view.state.camera,i,t),I(t.direction,t.direction),t}_pickMinResult(e){const t=ft(e,Bi.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,i,a){const s=this._pickMinResult(e),n=o.get();if(!s.getIntersectionPoint(n))return!1;const r=s.getTransformedNormal(o.get()),l=this.view.state.camera;z(r,l.viewForward)>0&&f(r,r,-1);const u=Ka(n,l),w=(t?1:-1)*u*ga,g=f(o.get(),r,w);b(g,g,n);const h=this.analysis.tiltEnabled?k.TILTED:k.HORIZONTAL_OR_VERTICAL,D=i[Ce]?k.VERTICAL:i[Ee]?k.HORIZONTAL:h;return Fa(g,r,u,u,l,D,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=vt(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=P,this.rotateHeadingManipulator.state|=P,this.rotateTiltManipulator.state|=P,this._prevPointerMoveTimeout=this.clock.setTimeout(()=>{this.shiftManipulator.state&=~P,this.rotateHeadingManipulator.state&=~P,this.rotateTiltManipulator.state&=~P},this._pointerMoveTimerMs)}_updateManipulators(){if(Ue.disableEngineLayers)return;let e=null,t=!1;if(d(this.analysisViewData.plane))e=this.analysisViewData.plane,t=!1;else{if(!d(this._previewPlane))return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);e=this._previewPlane,t=!0}const i=jt(e,N.get());t?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(r=>r.available=!0),qa(this.shiftManipulator,i,e,this.view.state.camera),Za(this.rotateHeadingManipulator,i,e,this.view.renderCoordsHelper),es(this.rotateTiltManipulator,i,e),this.resizeManipulators.forEach((r,l)=>Ja(r,this._resizeHandles[l],i,e)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=ne(o.get(),S(e.basis1),S(e.basis2),1),s=Ut(N.get(),a),n=Z(s,i,s);this._previewPlaneOutlineVisualElement.transform=n,this._previewPlaneGridVisualElement.transform=n,this._updateMaterials()}_updateMaterials(){const e=[ae[0],ae[1],ae[2],ae[3]*this._previewPlaneOpacity];this._previewPlaneOutlineVisualElement.color=e;const t=[se[0],se[1],se[2],se[3]*this._previewPlaneOpacity],i=[0,0,0,0];this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=i}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(t=>{t.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach(t=>{t.interactive=t===e})}testData(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}};function St(e,t,i,a){const s=Xa(i,Pe(a),e.direction,Ge()),n=ee();return fe(s,e,n)?{type:"shift",creatingPointerId:t,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function Ie(e){return e.pointerType!=="mouse"||e.button===0}V.disableEngineLayers=!1,c([p()],V.prototype,"clock",void 0),c([p({constructOnly:!0})],V.prototype,"view",void 0),c([p()],V.prototype,"analysisViewData",void 0),c([p({readOnly:!0})],V.prototype,"state",null),c([p({readOnly:!0})],V.prototype,"cursor",null),c([p()],V.prototype,"analysis",null),c([p()],V.prototype,"removeIncompleteOnCancel",void 0),c([p({readOnly:!0})],V.prototype,"layersMode",void 0),c([p({value:null})],V.prototype,"inputState",null),c([p()],V.prototype,"_isPlacingSlicePlane",null),c([p()],V.prototype,"_creatingPointerId",null),V=Ue=c([ce("esri.views.3d.analysis.Slice.SliceTool")],V);const vs=E(),fs=Ki(),_s=V;let L=class extends We{constructor(e){super(e),this._handles=new De,this._gridVisualElement=null,this._outlineVisualElement=null,this.state="pending",this.showGrid=!1,this.preview=!0}get ready(){return this.state==="ready"}initialize(){this._initialize()}async _initialize(){if(this.state==="destroyed"||this.state==="ready")return;await He(()=>this.view.ready);const e=this.analysisViewData;if(y(e))throw new Error("expected internal object to be valid");this._gridVisualElement=Xt(this.view),this._outlineVisualElement=Kt(this.view),this._handles.add([x(()=>({visible:d(e.plane)&&this.analysisViewData.visible,active:this.analysisViewData.active,preview:this.preview,showGrid:this.showGrid}),t=>this._updateMaterials(t),ze),x(()=>e.plane,t=>this._updatePlane(t),ze)],"internal"),this._set("state","ready")}destroy(){this.state!=="destroyed"&&this.state!=="pending"&&(this._handles.destroy(),this._gridVisualElement=X(this._gridVisualElement),this._outlineVisualElement=X(this._outlineVisualElement),this.set("view",null),this._set("state","destroyed"))}async whenReady(){await He(()=>this.view.ready)}_updatePlane(e){if(y(e))return;const t=ne(o.get(),S(e.basis1),S(e.basis2),1),i=Ut(N.get(),t),a=jt(e,N.get()),s=Z(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:e,active:t,preview:i,showGrid:a}){this._outlineVisualElement.color=ae,this._outlineVisualElement.width=i?Qt:Ft,this._outlineVisualElement.stipplePattern=t?null:Xi(5),this._gridVisualElement.backgroundColor=se,this._gridVisualElement.gridColor=a?Wt:qi,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};c([p({readOnly:!0})],L.prototype,"state",void 0),c([p()],L.prototype,"view",void 0),c([p()],L.prototype,"analysis",void 0),c([p()],L.prototype,"analysisViewData",void 0),c([p()],L.prototype,"ready",null),c([p()],L.prototype,"showGrid",void 0),c([p()],L.prototype,"preview",void 0),L=c([ce("esri.views.3d.analysis.Slice.SliceVisualization")],L);let R=class extends Zi(We){constructor(e){super(e),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0,this.showGrid=!1}initialize(){this.analysisVisualization=new L({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new F({view:this.view,analysis:this.analysis,analysisViewData:this}),this.own(ra(this,_s))}destroy(){la(this),this.analysisVisualization=X(this.analysisVisualization),this.analysisController=X(this.analysisController)}get editable(){return!this.analysisVisualization.preview}set editable(e){this.analysisVisualization.preview=!e}async when(){return await this.analysisVisualization.whenReady(),await this.analysisController.whenReady(),this}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController,tool:Ot(this.tool)}}};c([p({readOnly:!0})],R.prototype,"type",void 0),c([p({constructOnly:!0,nonNullable:!0})],R.prototype,"analysis",void 0),c([p()],R.prototype,"tool",void 0),c([p()],R.prototype,"plane",void 0),c([p()],R.prototype,"active",void 0),c([p({aliasOf:"analysisVisualization.showGrid"})],R.prototype,"showGrid",void 0),c([p()],R.prototype,"editable",null),R=c([ce("esri.views.3d.analysis.SliceAnalysisView3D")],R);const ms=R;var Ss=Object.freeze(Object.defineProperty({__proto__:null,default:ms},Symbol.toStringTag,{value:"Module"}));export{Ss as S,Ra as t};
